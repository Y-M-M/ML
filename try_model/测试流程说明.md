# 电表读数识别 - 自动化测试流程说明

## 🎯 功能概述

`run_test_pipeline.py` 是一个基于 `run_complete_pipeline.py` 设计的自动化测试全流程脚本，专门用于测试和评估电表读数识别系统的性能。

## 📋 主要功能

### 1. 环境检查 🔍
- ✅ 检查模型文件是否存在（YOLO + CRNN）
- ✅ 检查测试数据准备状态
- ✅ 自动选择可用的模型文件

### 2. 推理测试 🚀
- ✅ 支持多种测试模式：validation、all、comprehensive
- ✅ 自动运行端到端推理
- ✅ 生成预测结果文件

### 3. 模型评估 📊
- ✅ 运行详细的模型性能评估
- ✅ 提取关键性能指标

### 4. 结果分析 📈
- ✅ 自动分析测试结果
- ✅ 生成详细的JSON格式测试报告
- ✅ 检查所有输出文件

## 🚀 使用方法

### 基础使用

```bash
# 运行默认测试（验证集模式）
python run_test_pipeline.py

# 显示帮助信息
python run_test_pipeline.py --help
```

### 高级配置

```bash
# 使用特定CRNN模型进行测试
python run_test_pipeline.py --crnn_model crnn_improved_best.pth

# 运行全数据集测试
python run_test_pipeline.py --test_mode all

# 运行综合测试（多种模式）
python run_test_pipeline.py --test_mode comprehensive

# 跳过推理测试，仅进行模型评估
python run_test_pipeline.py --skip_inference

# 跳过模型评估，仅进行推理测试
python run_test_pipeline.py --skip_evaluation

# 自定义报告文件名
python run_test_pipeline.py --report_file my_test_report.json
```

## ⚙️ 参数说明

| 参数 | 选项 | 默认值 | 说明 |
|------|------|--------|------|
| `--test_mode` | validation/all/comprehensive | validation | 测试模式 |
| `--crnn_model` | 文件路径 | crnn_improved_best.pth | CRNN模型文件 |
| `--skip_inference` | 标志 | False | 跳过推理测试 |
| `--skip_evaluation` | 标志 | False | 跳过模型评估 |
| `--report_file` | 文件名 | auto_test_report.json | 测试报告文件名 |

## 📊 测试模式详解

### 1. validation 模式
- 🎯 在验证集上进行测试
- 📁 使用 `yolov8_dataset/images/val` 目录
- 📈 计算准确率和详细指标

### 2. all 模式
- 🎯 在全部数据集上进行测试
- 📁 使用 `Dataset` 目录（840张图像）
- 📈 全面的性能评估

### 3. comprehensive 模式
- 🎯 运行多种测试模式
- 📊 生成最全面的测试报告
- ⏱️ 执行时间较长但结果最完整

## 📁 输出文件

### 预测结果文件
- `validation_predictions.csv` - 验证集预测结果
- `all_predictions.csv` - 全数据集预测结果
- `test_predictions.csv` - 测试集预测结果

### 测试报告
- `auto_test_report.json` - 详细的JSON格式测试报告
- 包含：
  - 测试配置信息
  - 模型可用状态
  - 数据准备状态
  - 测试结果和性能指标
  - 时间戳和文件信息

## 🔧 依赖要求

### 必需文件
- `inference_pipeline_fixed.py` - 推理脚本
- `test_model.py` - 模型评估脚本（可选）
- `Dataset/labels.csv` - 标签文件

### 必需模型
至少需要以下模型之一：
- `runs/detect/meter_detection/weights/best.pt` - YOLO检测模型
- `crnn_improved_best.pth` - CRNN识别模型
- `crnn_recognizer_best.pth` - 备用CRNN模型

### 测试数据
- `yolov8_dataset/images/val/` - 验证集图像
- `Dataset/` - 原始数据集

## 📈 结果解读

### 测试报告结构
```json
{
  "timestamp": "2025-01-01T12:00:00",
  "tests_run": [
    {
      "test_name": "推理测试_validation",
      "result": "整体端到端识别准确率: 85.00% (143/168)"
    }
  ],
  "config": {
    "test_mode": "validation",
    "crnn_model": "crnn_improved_best.pth",
    "available_models": {...},
    "data_status": {...},
    "prediction_files": [...]
  }
}
```

### 关键指标
- **端到端识别准确率**: 完整的检测+识别流程准确率
- **处理图像数量**: 成功处理的图像总数
- **模型性能**: 各个子模块的详细性能

## 💡 使用建议

1. **首次运行**: 使用默认设置快速测试
   ```bash
   python run_test_pipeline.py
   ```

2. **性能评估**: 运行综合测试获得最全面的结果
   ```bash
   python run_test_pipeline.py --test_mode comprehensive
   ```

3. **调试模式**: 跳过耗时的步骤进行快速调试
   ```bash
   python run_test_pipeline.py --skip_evaluation
   ```

4. **结果查看**: 检查生成的报告和预测文件
   ```bash
   cat auto_test_report.json | jq .
   head validation_predictions.csv
   ```

## 🚨 常见问题

### 问题1: 模型文件不存在
```bash
❌ 没有找到任何可用的模型，请先训练模型!
```
**解决方案**: 先运行训练流程或确保模型文件在正确位置

### 问题2: 数据目录不存在
```bash
❌ 验证集图像: 不存在
```
**解决方案**: 确保已运行数据准备流程

### 问题3: 推理脚本缺失
```bash
❌ 命令执行失败: python inference_pipeline_fixed.py
```
**解决方案**: 确保 `inference_pipeline_fixed.py` 文件存在且可执行

---

📧 如有问题，请检查测试报告中的详细错误信息或联系开发团队。 